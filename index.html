<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Personal Notes</title>
    
    <!-- PWA / Mobile Web App Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    
    <style>
        :root {
            --bg-root: #09090b;
            --bg-sidebar: #121214;
            --bg-card: #18181b;
            --border-color: #27272a;
            --accent-primary: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.5);
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
        }

        body { 
            background-color: var(--bg-root); 
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow: hidden; 
            overscroll-behavior-y: none; /* Prevent bounce */
        }

        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* Typography & Markdown */
        .prose { 
            max-width: 100%; 
            color: #d4d4d8; 
            font-size: 1.05rem; 
            line-height: 1.7; 
        }
        .prose h1, .prose h2, .prose h3, .prose h4 { color: #fff; scroll-margin-top: 6rem; }
        .prose h1 { font-weight: 800; letter-spacing: -0.025em; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; font-size: 1.75rem; }
        @media (min-width: 768px) { .prose h1 { font-size: 2.25rem; } }
        
        .prose h2 { font-weight: 700; border-left: 4px solid var(--accent-primary); padding-left: 1rem; margin-top: 2.5rem; font-size: 1.4rem; }
        .prose a { color: #60a5fa; text-decoration: none; border-bottom: 1px dashed rgba(96, 165, 250, 0.4); word-break: break-all; }
        .prose a:hover { border-bottom-style: solid; }
        .prose code { color: #f472b6; background: rgba(244, 114, 182, 0.08); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; font-weight: 500; word-break: break-word; }
        .prose pre { background: #131315; border: 1px solid var(--border-color); border-radius: 8px; overflow-x: auto; }
        .prose ul > li::marker { color: #52525b; }
        .prose blockquote { border-left-color: var(--accent-primary); background: rgba(59, 130, 246, 0.05); color: #a1a1aa; border-radius: 0 8px 8px 0; }
        
        /* "First Principles" Specifics */
        .prose ul > li > strong:first-child { color: #38bdf8; display: inline-block; margin-bottom: 0.1em; }

        /* Utilities */
        .glass { background: rgba(9, 9, 11, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .glass-card { background: rgba(39, 39, 42, 0.4); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.05); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .nav-item { transition: background-color 0.15s, color 0.15s; }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; border-right: 2px solid #60a5fa; }

        /* Copy Button */
        .copy-btn {
            position: absolute; top: 0.5rem; right: 0.5rem;
            padding: 0.25rem 0.6rem; background: #27272a; border: 1px solid #3f3f46;
            border-radius: 4px; font-size: 0.75rem; color: #a1a1aa; cursor: pointer;
            opacity: 0; transition: all 0.2s; font-family: 'Inter', sans-serif; font-weight: 500;
        }
        pre:hover .copy-btn { opacity: 1; }
        .copy-btn:hover { background: #3f3f46; color: white; }
        .copy-btn.copied { background: #10b981; color: white; border-color: #10b981; }

        /* Safe Area for Mobile (iPhone Notch) */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body>

<div id="root"></div>

<script>
    // Dynamic Manifest Generation for standalone PWA support
    const manifest = {
        "name": "Personal Notes",
        "short_name": "Notes",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#09090b",
        "theme_color": "#09090b",
        "icons": [{
            "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath d='M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z'/%3E%3C/svg%3E",
            "type": "image/svg+xml",
            "sizes": "192x192"
        }]
    };
    const stringManifest = JSON.stringify(manifest);
    const blob = new Blob([stringManifest], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(blob);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);
</script>

<script type="text/babel">

const { useState, useEffect, useMemo, useRef, useCallback } = React;
const apiKey = ""; 

// --- Icons ---
const Icons = {
    Folder: () => <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>,
    FolderOpen: () => <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"/></svg>,
    File: () => <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>,
    Search: () => <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
    Settings: () => <svg className="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
    Menu: () => <svg className="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/></svg>,
    X: () => <svg className="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>,
    ChevronRight: () => <svg className="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"/></svg>,
    Calendar: () => <svg className="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
    Tag: () => <svg className="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>,
    List: () => <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h7"/></svg>,
    Sparkles: () => <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>,
    Brain: () => <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>,
    Chat: () => <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>,
    Lightning: () => <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>,
    Github: () => <svg className="w-5 h-5 shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
};

// --- Utilities ---

const buildTree = (files) => {
    const root = { name: 'root', path: '', type: 'tree', children: {} };
    files.forEach(file => {
        if (file.path.startsWith('.') || file.path.includes('assets/')) return;
        
        const parts = file.path.split('/');
        let current = root;
        parts.forEach((part, index) => {
            if (!current.children[part]) {
                current.children[part] = {
                    name: part,
                    path: parts.slice(0, index + 1).join('/'),
                    type: index === parts.length - 1 ? file.type : 'tree',
                    children: {},
                    sha: file.sha,
                    url: file.url
                };
            }
            current = current.children[part];
        });
    });
    return root.children;
};

// --- Components ---

const AIAssistant = ({ content, apiKey, onClose, title }) => {
    const [prompt, setPrompt] = useState("");
    const [response, setResponse] = useState("");
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const callGemini = async (customPrompt) => {
        setLoading(true);
        setError(null);
        setResponse("");
        
        try {
            if (!apiKey) throw new Error("Gemini API Key is missing. Please add it in Settings.");

            const fullPrompt = `
                Context: The user is reading a technical note titled "${title}".
                Note Content:
                ${content.substring(0, 15000)} 
                
                Task: ${customPrompt}
                
                Output Format: Markdown. Be concise and helpful.
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: fullPrompt }] }]
                })
            });

            if (!res.ok) throw new Error(`Gemini API Error: ${res.statusText}`);
            
            const data = await res.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            setResponse(text);
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    const actions = [
        { label: "Summarize", icon: <Icons.Lightning />, prompt: "Summarize this note in 3-5 concise bullet points. Focus on the 'First Principles' and 'Key Takeaways'." },
        { label: "Quiz", icon: <Icons.Brain />, prompt: "Create a 3-question multiple choice quiz based on this note to test my understanding. Put the answers at the very end hidden behind a spoiler." },
        { label: "ELI5", icon: <Icons.Chat />, prompt: "Explain the core concept of this note like I am 5 years old. Use a simple analogy." }
    ];

    return (
        <div className="fixed inset-y-0 right-0 w-full md:w-[450px] bg-[#121214] border-l border-white/10 shadow-2xl z-50 flex flex-col animate-fade-in safe-pt safe-pb">
            {/* Header */}
            <div className="p-4 border-b border-white/10 flex justify-between items-center bg-[#09090b]">
                <div className="flex items-center gap-2">
                    <span className="text-blue-400"><Icons.Sparkles /></span>
                    <h3 className="font-bold text-white text-lg">AI Assistant</h3>
                </div>
                <button onClick={onClose} className="text-gray-400 hover:text-white p-2"><Icons.X /></button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                <div className="grid grid-cols-3 gap-2 mb-6">
                    {actions.map((action, idx) => (
                        <button 
                            key={idx}
                            onClick={() => callGemini(action.prompt)}
                            disabled={loading}
                            className="flex flex-col items-center justify-center gap-2 p-3 rounded-lg bg-[#18181b] border border-white/5 hover:bg-[#27272a] hover:border-blue-500/30 transition-all text-xs font-medium text-gray-300 hover:text-white group active:scale-95"
                        >
                            <span className="text-gray-500 group-hover:text-blue-400 transition-colors">{action.icon}</span>
                            {action.label}
                        </button>
                    ))}
                </div>

                {loading && (
                    <div className="flex flex-col items-center justify-center py-12 space-y-4">
                        <div className="w-8 h-8 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"></div>
                        <p className="text-xs text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 animate-pulse font-medium">Thinking...</p>
                    </div>
                )}

                {error && (
                    <div className="p-4 rounded-lg bg-red-900/20 border border-red-500/30 text-red-300 text-sm">
                        {error}
                    </div>
                )}

                {!loading && response && (
                    <div className="animate-fade-in">
                        <div className="prose prose-invert prose-sm max-w-none">
                            <div dangerouslySetInnerHTML={{ __html: marked.parse(response) }} />
                        </div>
                    </div>
                )}

                {!loading && !response && !error && (
                    <div className="text-center text-gray-600 text-sm py-8">
                        Select an action above to analyze this note.
                    </div>
                )}
            </div>
        </div>
    );
};

const Breadcrumbs = ({ path, allFiles, onNavigate }) => {
    if (!path) return null;
    const parts = path.split('/');
    
    return (
        <nav className="flex items-center gap-2 text-sm text-gray-500 mb-6 font-medium overflow-x-auto whitespace-nowrap pb-2 no-scrollbar">
            <button 
                onClick={() => onNavigate(null)}
                className="hover:text-blue-400 transition-colors flex items-center p-1"
            >
                <span className="sr-only">Home</span>
                <Icons.Folder />
            </button>
            
            {parts.map((part, index) => {
                const isLast = index === parts.length - 1;
                const fullPath = parts.slice(0, index + 1).join('/');
                const targetNode = allFiles ? allFiles.find(f => f.path === fullPath) : null;
                const itemToNav = targetNode || { 
                    path: fullPath, 
                    type: isLast && fullPath.endsWith('.md') ? 'blob' : 'tree', 
                    name: part 
                };

                return (
                    <div key={fullPath} className="flex items-center gap-1.5 flex-shrink-0">
                        <span className="text-gray-600"><Icons.ChevronRight /></span>
                        <button
                            onClick={() => onNavigate(itemToNav)}
                            className={`transition-colors px-2 py-1 rounded
                                ${isLast 
                                    ? "text-blue-400 bg-blue-500/10 cursor-default" 
                                    : "hover:text-gray-200 hover:bg-gray-800"
                                }`}
                            disabled={isLast}
                        >
                            {part.replace('.md', '')}
                        </button>
                    </div>
                );
            })}
        </nav>
    );
};

const SidebarItem = ({ item, level, onSelect, activePath }) => {
    const [isOpen, setIsOpen] = useState(false);
    const hasChildren = item.type === 'tree' && Object.keys(item.children).length > 0;
    const isFile = item.type === 'blob';
    const isActive = activePath === item.path;

    useEffect(() => {
        if (activePath && activePath.startsWith(item.path + '/')) setIsOpen(true);
    }, [activePath, item.path]);

    const handleClick = (e) => {
        e.stopPropagation();
        onSelect(item);
        if (hasChildren && !isFile) setIsOpen(!isOpen);
    };

    const sortedChildren = Object.values(item.children || {}).sort((a, b) => {
        if (a.type !== b.type) return a.type === 'tree' ? -1 : 1;
        return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
    });

    return (
        <div>
            <div 
                className={`nav-item flex items-center gap-2.5 px-3 py-2 cursor-pointer text-sm select-none my-0.5 mx-2 rounded-md ${isActive ? 'active' : 'text-gray-400'}`}
                style={{ paddingLeft: `${level * 16 + 12}px` }}
                onClick={handleClick}
            >
                <span className={isFile ? "text-gray-500" : (isOpen ? "text-blue-400" : "text-gray-500")}>
                    {isFile ? <Icons.File /> : (isOpen ? <Icons.FolderOpen /> : <Icons.Folder />)}
                </span>
                <span className={`truncate ${isFile ? '' : 'font-medium'}`}>
                    {item.name.replace('.md', '')}
                </span>
            </div>
            {hasChildren && isOpen && (
                <div className="relative">
                     <div className="absolute left-0 top-0 bottom-0 w-px bg-gray-800/50" style={{ left: `${level * 16 + 19}px` }} />
                    {sortedChildren.map(child => (
                        <SidebarItem key={child.path} item={child} level={level + 1} onSelect={onSelect} activePath={activePath} />
                    ))}
                </div>
            )}
        </div>
    );
};

const TableOfContents = ({ content }) => {
    const headings = useMemo(() => {
        if (!content) return [];
        const lines = content.split('\n');
        const matches = [];
        const regex = /^(#{1,3})\s+(.+)$/;
        lines.forEach((line) => {
            const match = line.match(regex);
            if (match) {
                matches.push({
                    level: match[1].length,
                    text: match[2].trim(),
                    id: match[2].toLowerCase().replace(/[^\w]+/g, '-')
                });
            }
        });
        return matches;
    }, [content]);

    if (headings.length < 2) return null;

    return (
        <div className="hidden xl:block w-64 fixed right-8 top-32 overflow-y-auto max-h-[80vh] custom-scrollbar pb-8">
            <h4 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 pl-3 border-l-2 border-transparent">On this page</h4>
            <ul className="space-y-1">
                {headings.map((h, i) => (
                    <li key={i} className={`text-sm ${h.level === 3 ? 'pl-4' : ''}`}>
                        <a href={`#${h.id}`} onClick={(e) => { e.preventDefault(); document.getElementById(h.id)?.scrollIntoView({ behavior: 'smooth' }); }}
                            className="block py-1 pl-3 border-l-2 border-gray-800 text-gray-400 hover:border-blue-500 hover:text-blue-400 transition-colors truncate">
                            {h.text}
                        </a>
                    </li>
                ))}
            </ul>
        </div>
    );
};

const FolderDashboard = ({ folder, allFiles, onNavigate }) => {
    const folderFiles = useMemo(() => {
        if (!folder) return [];
        return allFiles.filter(f => {
            const isChild = f.path.startsWith(folder.path + '/') && f.type === 'blob' && f.path.endsWith('.md');
            const relativePath = f.path.slice(folder.path.length + 1);
            return isChild && !relativePath.includes('/');
        });
    }, [folder, allFiles]);

    return (
        <div className="max-w-5xl mx-auto p-4 md:p-12 animate-fade-in">
            <div className="mb-8 pb-4 border-b border-gray-800">
                <h1 className="text-2xl md:text-3xl font-bold text-white mb-2 break-words">{folder.name}</h1>
                <p className="text-gray-400 text-sm">Folder Overview • {folderFiles.length} Notes</p>
            </div>
            {folderFiles.length === 0 ? (
                <div className="text-center py-20 bg-[#121214] rounded-xl border border-gray-800 border-dashed mx-2">
                    <p className="text-gray-500">No notes found in this directory.</p>
                </div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                    {folderFiles.map(file => (
                        <div key={file.path} onClick={() => onNavigate(file)} className="group bg-[#18181b] border border-gray-800 rounded-lg p-4 cursor-pointer hover:border-blue-500/50 hover:bg-[#1f1f22] transition-all relative overflow-hidden active:scale-[0.98]">
                            <div className="absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.ChevronRight /></div>
                            <div className="flex items-center gap-2 mb-3 text-blue-400"><Icons.File /></div>
                            <h3 className="text-base font-semibold text-gray-200 mb-1 group-hover:text-white truncate">{file.path.split('/').pop().replace('.md', '')}</h3>
                            <p className="text-xs text-gray-500 font-mono truncate">{file.path}</p>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

const SettingsModal = ({ isOpen, onClose, currentRepo, currentToken, currentGeminiKey, onSave }) => {
    if (!isOpen) return null;
    const [repo, setRepo] = useState(currentRepo);
    const [token, setToken] = useState(currentToken);
    const [geminiKey, setGeminiKey] = useState(currentGeminiKey);

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] p-4 animate-fade-in">
            <div className="bg-[#18181b] p-6 rounded-xl border border-gray-700 w-full max-w-md shadow-2xl relative">
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-white"><Icons.X /></button>
                <h2 className="text-xl font-bold text-white mb-6">Settings</h2>
                
                <div className="space-y-4">
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold tracking-wider mb-2">GitHub Repository</label>
                        <input type="text" value={repo} onChange={(e) => setRepo(e.target.value)}
                            className="w-full bg-[#09090b] border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none" placeholder="user/repo" />
                    </div>
                    <div>
                        <label className="block text-gray-400 text-xs uppercase font-bold tracking-wider mb-2">GitHub Token (Optional)</label>
                        <input type="password" value={token} onChange={(e) => setToken(e.target.value)}
                            className="w-full bg-[#09090b] border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none" placeholder="ghp_..." />
                    </div>
                    <div>
                        <label className="block text-blue-400 text-xs uppercase font-bold tracking-wider mb-2 flex items-center gap-2">
                            <Icons.Sparkles /> Gemini API Key
                        </label>
                        <input type="password" value={geminiKey} onChange={(e) => setGeminiKey(e.target.value)}
                            className="w-full bg-[#09090b] border border-blue-900/50 rounded-lg p-3 text-white focus:border-blue-500 outline-none placeholder-blue-900/50" placeholder="AI_..." />
                        <p className="text-xs text-gray-500 mt-2">Required for AI features. <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-400 hover:underline">Get Key</a></p>
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 text-gray-400 hover:text-white text-sm">Cancel</button>
                    <button onClick={() => { onSave(repo, token, geminiKey); onClose(); }} 
                        className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-lg shadow-blue-500/20">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    );
};

const App = () => {
    const [allFiles, setAllFiles] = useState([]);
    const [tree, setTree] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [selectedItem, setSelectedItem] = useState(null); 
    const [content, setContent] = useState(null);
    const [metadata, setMetadata] = useState(null);
    const [showAIPanel, setShowAIPanel] = useState(false);
    const [settingsOpen, setSettingsOpen] = useState(false);
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
    const [searchQuery, setSearchQuery] = useState("");
    const searchInputRef = useRef(null);

    const [repo, setRepo] = useState(localStorage.getItem('notes_repo') || 'unikdahal/my-personal-notes');
    const [token, setToken] = useState(localStorage.getItem('notes_token') || '');
    const [geminiKey, setGeminiKey] = useState(localStorage.getItem('gemini_key') || apiKey);

    useEffect(() => {
        const handleKeyDown = (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                searchInputRef.current?.focus();
            }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, []);

    useEffect(() => {
        const fetchTree = async () => {
            setLoading(true); setError(null);
            try {
                const headers = token ? { Authorization: `Bearer ${token}` } : {};
                const res = await fetch(`https://api.github.com/repos/${repo}/git/trees/main?recursive=1`, { headers });
                if (!res.ok) throw new Error(res.status === 404 ? "Repo not found" : `API Error: ${res.status}`);
                const data = await res.json();
                
                const validFiles = data.tree.filter(file => {
                    if (file.path.startsWith('.') || file.path.includes('assets/')) return false;
                    if (file.path.toLowerCase() === 'index.html') return false;
                    if (file.type === 'tree') return true;
                    if (file.type === 'blob' && file.path.endsWith('.md')) return true;
                    return false;
                }).map(file => ({
                    ...file,
                    name: file.path.split('/').pop() 
                }));
                
                setAllFiles(validFiles);
                setTree(buildTree(validFiles));
            } catch (err) { setError(err.message); } 
            finally { setLoading(false); }
        };
        fetchTree();
    }, [repo, token]);

    useEffect(() => {
        if (!selectedItem || selectedItem.type === 'tree') {
            setContent(null); setMetadata(null); setShowAIPanel(false);
            return;
        }

        const fetchContent = async () => {
            setContent(null); setMobileMenuOpen(false);
            try {
                const headers = token ? { Authorization: `Bearer ${token}` } : {};
                const url = selectedItem.sha 
                    ? `https://api.github.com/repos/${repo}/git/blobs/${selectedItem.sha}`
                    : `https://api.github.com/repos/${repo}/contents/${selectedItem.path}`;
                
                const res = await fetch(url, { headers });
                if (!res.ok) throw new Error("Failed to load file");
                const data = await res.json();
                if (Array.isArray(data)) throw new Error("Path is a directory.");
                if (!data.content || typeof data.content !== 'string') throw new Error("File empty/unavailable.");

                const binary = atob(data.content.replace(/\s/g, ''));
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                const decoded = new TextDecoder('utf-8').decode(bytes);

                const fmMatch = decoded.match(/^---\s*[\r\n]+([\s\S]*?)[\r\n]+---/);
                let markdown = decoded;
                let meta = {};
                
                if (fmMatch) {
                    try { meta = jsyaml.load(fmMatch[1]); } catch(e) { console.warn("YAML Error", e); }
                    markdown = decoded.replace(fmMatch[0], '');
                }
                setMetadata(meta);
                
                const processedMarkdown = markdown.split('\n').map(line => {
                    const match = line.match(/^(#{1,3})\s+(.+)$/);
                    if (match) return `${match[1]} ${match[2]} <a id="${match[2].toLowerCase().replace(/[^\w]+/g, '-')}" class="anchor"></a>`;
                    return line;
                }).join('\n');

                setContent(processedMarkdown);
            } catch (err) { setContent(`> Error: ${err.message}`); }
        };
        fetchContent();
    }, [selectedItem, repo, token]);

    useEffect(() => {
        if (content) {
            hljs.highlightAll();
            document.querySelectorAll('pre').forEach((pre) => {
                if (pre.querySelector('.copy-btn')) return;
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.textContent = 'Copy';
                btn.onclick = () => {
                    const code = pre.querySelector('code')?.innerText;
                    if(code) { navigator.clipboard.writeText(code); btn.textContent = 'Copied!'; btn.classList.add('copied'); setTimeout(()=> {btn.textContent='Copy'; btn.classList.remove('copied')}, 2000); }
                };
                pre.appendChild(btn);
            });
        }
    }, [content]);

    const filteredFiles = useMemo(() => {
        if (!searchQuery) return [];
        return allFiles.filter(f => f.path.toLowerCase().includes(searchQuery.toLowerCase()));
    }, [allFiles, searchQuery]);

    const renderMarkdown = useMemo(() => {
        if (!content) return { __html: '' };
        return { __html: marked.parse(content) };
    }, [content]);

    const saveSettings = (newRepo, newToken, newGeminiKey) => {
        localStorage.setItem('notes_repo', newRepo);
        localStorage.setItem('notes_token', newToken);
        localStorage.setItem('gemini_key', newGeminiKey);
        setRepo(newRepo); setToken(newToken); setGeminiKey(newGeminiKey);
        window.location.reload();
    };

    return (
        <div className="flex h-screen text-sm bg-[#09090b] overflow-hidden">
            <div className="md:hidden fixed top-0 w-full glass z-50 border-b border-white/10 px-4 py-3 flex justify-between items-center safe-pt">
                <span className="font-bold text-white flex items-center gap-2 text-base"><Icons.Github /> Personal Notes</span>
                <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="text-gray-400 p-1"><Icons.Menu /></button>
            </div>

            <div className={`fixed inset-y-0 left-0 z-40 w-80 bg-[#121214] border-r border-white/5 flex flex-col transform transition-transform duration-300 ease-out ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:relative pt-20 md:pt-0`}>
                <div className="p-4 border-b border-white/5 safe-pt">
                    <div className="hidden md:flex items-center gap-2 font-bold text-gray-200 mb-4 tracking-tight"><Icons.Github /> <span className="truncate">{repo.split('/')[1]}</span></div>
                    <div className="relative group">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500 group-focus-within:text-blue-500"><Icons.Search /></div>
                        <input ref={searchInputRef} type="text" className="w-full bg-[#18181b] text-gray-300 border border-gray-800 rounded-lg py-2 pl-9 pr-12 focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 focus:bg-[#09090b] outline-none transition-all placeholder-gray-600" placeholder="Search..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto custom-scrollbar py-2">
                    {loading && <div className="p-8 text-center text-gray-500 animate-pulse">Loading Tree...</div>}
                    {error && <div className="p-4 text-center text-red-400 text-xs">{error}</div>}
                    {!loading && !error && (
                        searchQuery ? (
                            <div className="px-2">
                                <div className="text-xs font-bold text-gray-500 uppercase px-3 py-2">Search Results</div>
                                {filteredFiles.map(file => (
                                    <div key={file.path} onClick={() => setSelectedItem(file)} className="nav-item flex flex-col px-3 py-2 cursor-pointer mb-1 rounded-md">
                                        <span className="text-gray-200 font-medium truncate">{file.path.split('/').pop().replace('.md','')}</span>
                                        <span className="text-xs text-gray-600 truncate">{file.path}</span>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            tree && Object.values(tree).sort((a,b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' })).map(item => (
                                <SidebarItem key={item.path} item={item} level={0} onSelect={setSelectedItem} activePath={selectedItem?.path} />
                            ))
                        )
                    )}
                </div>

                <div className="p-4 border-t border-white/5 safe-pb">
                    <button onClick={() => setSettingsOpen(true)} className="flex items-center gap-2 text-gray-400 hover:text-white transition-colors w-full px-2 py-1.5 rounded-md hover:bg-white/5">
                        <Icons.Settings /> <span className="font-medium">Settings</span>
                    </button>
                </div>
            </div>

            <div className="flex-1 overflow-y-auto relative custom-scrollbar bg-[#09090b]">
                <div className="pt-24 md:pt-8 px-4 md:px-12 pb-32 max-w-7xl mx-auto safe-pt safe-pb">
                    {selectedItem && <Breadcrumbs path={selectedItem.path} allFiles={allFiles} onNavigate={setSelectedItem} />}

                    {!selectedItem ? (
                        <div className="h-[70vh] flex flex-col items-center justify-center text-center animate-fade-in px-4">
                            <div className="w-20 h-20 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-2xl flex items-center justify-center mb-6 border border-white/10 shadow-2xl"><span className="text-blue-400"><Icons.FolderOpen /></span></div>
                            <h1 className="text-3xl font-bold text-white mb-2">My Personal Notes</h1>
                            <p className="text-gray-500 max-w-md">Select a folder or note to begin.</p>
                            {!geminiKey && <p className="mt-4 text-xs text-blue-400 bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20 animate-pulse cursor-pointer" onClick={() => setSettingsOpen(true)}>✨ Configure AI Key in Settings</p>}
                        </div>
                    ) : selectedItem.type === 'tree' ? (
                        <FolderDashboard folder={selectedItem} allFiles={allFiles} onNavigate={setSelectedItem} />
                    ) : (
                        <div className="flex gap-12 animate-fade-in relative flex-col xl:flex-row">
                            <div className="flex-1 min-w-0">
                                <div className="mb-8 pb-6 border-b border-gray-800 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                    <div className="flex-1 w-full">
                                        <h1 className="text-2xl sm:text-3xl md:text-4xl font-extrabold text-white mb-3 tracking-tight leading-tight break-words hyphens-auto">
                                            {metadata?.title || (selectedItem.name || selectedItem.path.split('/').pop()).replace('.md', '')}
                                        </h1>
                                        <div className="flex flex-wrap items-center gap-2 text-xs sm:text-sm">
                                            {metadata?.status && <span className={`px-2 py-0.5 rounded text-[10px] sm:text-xs font-bold uppercase tracking-wider border ${metadata.status === 'permanent' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : metadata.status === 'draft' ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' : 'bg-gray-800 text-gray-400 border-gray-700'}`}>{metadata.status}</span>}
                                            {metadata?.tags && metadata.tags.map(tag => <span key={tag} className="flex items-center gap-1 text-gray-400 bg-white/5 border border-white/10 px-2 py-0.5 rounded"><Icons.Tag /> {tag}</span>)}
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => setShowAIPanel(!showAIPanel)}
                                        className={`p-2.5 rounded-lg border transition-all self-end sm:self-center shrink-0 ${showAIPanel ? 'bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-500/30' : 'bg-[#18181b] border-gray-700 text-gray-400 hover:text-blue-400 hover:border-blue-500/50'}`}
                                        title="Toggle AI Assistant"
                                    >
                                        <Icons.Sparkles />
                                    </button>
                                </div>
                                {content ? <article className="prose prose-invert prose-lg max-w-none" dangerouslySetInnerHTML={renderMarkdown} /> : (
                                    <div className="space-y-4 animate-pulse">
                                        <div className="h-4 bg-white/5 rounded w-3/4"></div>
                                        <div className="h-4 bg-white/5 rounded w-1/2"></div>
                                        <div className="h-32 bg-white/5 rounded mt-8"></div>
                                    </div>
                                )}
                            </div>
                            <TableOfContents content={content} />
                            
                            {/* AI Panel Overlay */}
                            {showAIPanel && (
                                <AIAssistant 
                                    content={content || ""} 
                                    apiKey={geminiKey} 
                                    title={metadata?.title || selectedItem.name}
                                    onClose={() => setShowAIPanel(false)} 
                                />
                            )}
                        </div>
                    )}
                </div>
            </div>

            <SettingsModal 
                isOpen={settingsOpen} 
                onClose={() => setSettingsOpen(false)} 
                currentRepo={repo} 
                currentToken={token} 
                currentGeminiKey={geminiKey}
                onSave={saveSettings} 
            />
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

</script>
</body>
</html>